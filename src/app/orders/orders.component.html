<div class="container py-4 mt-nav">
  <!-- Filters -->
  <div class="row g-3 mb-4 align-items-end">
    <div class="col-md-6">
      <label class="form-label fw-bold">๐ ุจุญุซ ุจุงุณู ุงูุนููู</label>
      <input type="text" [(ngModel)]="searchQuery" (ngModelChange)="applyFilters()" class="form-control" placeholder="ุงูุชุจ ุงุณู ุงูุนููู..." />
    </div>
    <div class="col-md-6">
      <label class="form-label fw-bold">๐ ุงูุญุงูุฉ</label>
      <select class="form-select" [(ngModel)]="selectedStatus" (change)="applyFilters()">
        <option value="">ุฌููุน ุงูุญุงูุงุช</option>
        <option value="AwaitingWorkerAcceptance">๐ ูู ุงูุชุธุงุฑ ููุงููุฉ ุงูุนุงูู</option>
        <option value="ApprovedAndScheduled">โ ุชู ุงูููุงููุฉ</option>
        <option value="WaitOtpCodeCompleted">๐ ุงูุชุธุงุฑ ุฑูุฒ ุงูุชุฃููุฏ</option>
        <option value="Completed">๐ ุชู ุงูุชูููุฐ</option>
        <option value="Cancelled">โ ุชู ุงูุฅูุบุงุก</option>
      </select>
    </div>
  </div>

  <!-- Orders -->
  <div *ngFor="let order of filteredOrders" class="card mb-4 shadow-lg rounded-4"
       [ngClass]="{
         'border-start border-4 border-warning': order.status === 'AwaitingWorkerAcceptance',
         'border-start border-4 border-info': order.status === 'ApprovedAndScheduled',
         'border-start border-4 border-success': order.status === 'Completed',
         'border-start border-4 border-dark': order.status === 'WaitOtpCodeCompleted',
         'border-start border-4 border-danger': order.status === 'Cancelled'
       }">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold text-primary mb-0">๐ฆ ุทูุจ ุฑูู: {{ order.id }}</h4>
        <span class="badge fs-6 px-3 py-2"
          [ngClass]="{
            'bg-warning text-dark': order.status === 'AwaitingWorkerAcceptance',
            'bg-info text-dark': order.status === 'ApprovedAndScheduled',
            'bg-success': order.status === 'Completed',
            'bg-secondary': order.status === 'WaitOtpCodeCompleted',
            'bg-danger': order.status === 'Cancelled'
          }">{{ order.status }}</span>
      </div>

      <ul class="list-unstyled mb-4 fs-6">
        <li>
          <strong>๐ค ุงูุนููู:</strong> {{ order.customerName }}
          <span *ngIf="ratingSummaries[order.customerId]">
            - โญ {{ ratingSummaries[order.customerId]['averageRating'] | number: '1.1-1' }}
          </span>
        </li>
        <li>
          <strong>๐งฐ ุงูููู:</strong> {{ order.workerName }}
          <span *ngIf="ratingSummaries[order.workerId]">
            - โญ {{ ratingSummaries[order.workerId]['averageRating'] | number: '1.1-1' }}
          </span>
        </li>
        <li><strong>๐ฐ ุงูุณุนุฑ:</strong> {{ order.totalAmount }} ุฌ.ู</li>
        <li><strong>๐ ุงูุชุงุฑูุฎ:</strong> {{ order.scheduledDate | date:'medium' }}</li>
      </ul>

      <!-- Review Form -->
      <!-- โญ Review Display OR Form -->
<div *ngIf="order.status === 'Completed'">
  <!-- โ ุนุฑุถ ุงูุชูููู ูู ุงููุณุชุฎุฏู ูููู ุจุงููุนู -->
  <div *ngIf="hasUserReviewed(order)">
    <p class="mb-1"><strong>โ ุชููููู:</strong></p>
    <p>โญ {{ getMyReview(order)?.rating }} / 5</p>
    <p><em>{{ getMyReview(order)?.comment }}</em></p>
      <!-- <button class="btn btn-sm btn-outline-danger" (click)="deleteReview(order)">
      ๐๏ธ ุญุฐู ุงูุชูููู
    </button> -->
  </div>

  <!-- ๐ ุนุฑุถ ููุฑู ุงูุชูููู ูู ูุณู ูุง ููููุด -->
  <div *ngIf="!hasUserReviewed(order)">
    <label class="form-label">โจ ุชูููู ุงูููู:</label>
    <div class="d-flex align-items-center gap-2">
      <ng-container *ngFor="let star of [1,2,3,4,5]">
       <i class="fa-star fa fs-4"
 [ngClass]="{
  'fas text-warning': hoveredStar >= star || ratingForm[order.id].rating >= star,
  'far text-muted': hoveredStar < star && ratingForm[order.id].rating < star
}"

   (mouseenter)="hoveredStar = star"
   (mouseleave)="hoveredStar = 0"
   (click)="setRating(order.id, star)">
</i>

      </ng-container>
    </div>
    <textarea class="form-control mt-2" rows="2" [(ngModel)]="ratingForm[order.id].comment" placeholder="ุงูุชุจ ุชุนููููุง (ุงุฎุชูุงุฑู)"></textarea>
    <button class="btn btn-sm btn-primary mt-2 fw-bold" (click)="submitReview(order)">โ ุฅุฑุณุงู ุงูุชูููู</button>
  </div>
</div>


      <!-- Actions -->
       <div class="row g-3">
        <div class="col-md-4" *ngIf="!isWorker && order.status === 'AwaitingWorkerAcceptance'">
          <input class="form-control" type="number" [(ngModel)]="newTotalAmount" placeholder="ุณุนุฑ ุฌุฏูุฏ" />
          <button class="btn btn-outline-warning w-100 mt-1 fw-bold" (click)="updateTotalAmount(order.id)">๐ต ุชุญุฏูุซ ุงูุณุนุฑ</button>
        </div>

        <div class="col-md-4" *ngIf="!isWorker && order.status === 'AwaitingWorkerAcceptance'">
          <input class="form-control" type="date" [(ngModel)]="newScheduledDate" />
          <button class="btn btn-outline-info w-100 mt-1 fw-bold" (click)="updateDate(order.id)">๐ ุชุญุฏูุซ ุงูุชุงุฑูุฎ</button>
        </div>

        <div class="col-md-4" *ngIf="!isWorker && order.status !== 'Completed'">
          <input class="form-control" type="text" [(ngModel)]="cancelReason" placeholder="ุณุจุจ ุงูุฅูุบุงุก" />
          <button class="btn btn-outline-danger w-100 mt-1 fw-bold" (click)="cancelOrder(order.id)">โ ุฅูุบุงุก ุงูุทูุจ</button>
        </div>

        <div class="col-md-4" *ngIf="isWorker && order.status === 'WaitOtpCodeCompleted'">
          <input class="form-control" type="text" [(ngModel)]="workerOtpCode" placeholder="OTP ูู ุงูุนููู" />
          <button class="btn btn-dark w-100 mt-1 fw-bold" (click)="workerCompleteOrder(order.id)">๐งโ๐ง ุฅุชูุงู ุงูููู</button>
        </div>

        <div class="col-md-4" *ngIf="!isWorker && order.status === 'ApprovedAndScheduled'">
          <button class="btn btn-success w-100 fw-bold" (click)="completeOrder(order.id)">๐ฏ ุฅุชูุงู ุงูุนููู</button>
        </div>

        <div class="col-md-4" *ngIf="isWorker && order.status === 'AwaitingWorkerAcceptance'">
          <button class="btn btn-primary w-100 fw-bold" (click)="acceptOrder(order.id)">๐ค ูุจูู ุงูููู</button>
        </div>

        <div class="col-md-4" *ngIf="order.status !== 'Completed'">
          <button class="btn btn-outline-secondary w-100 fw-bold" (click)="goToChat(order)">๐ฌ ุงููุญุงุฏุซุฉ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <nav *ngIf="totalPages > 1" class="d-flex justify-content-center mt-4">
    <ul class="pagination">
      <li class="page-item" [class.disabled]="pageIndex === 1">
        <button class="page-link" (click)="goToPage(pageIndex - 1)">ุงูุณุงุจู</button>
      </li>
      <li class="page-item disabled">
        <span class="page-link">ุตูุญุฉ {{ pageIndex }} ูู {{ totalPages }}</span>
      </li>
      <li class="page-item" [class.disabled]="pageIndex === totalPages">
        <button class="page-link" (click)="goToPage(pageIndex + 1)">ุงูุชุงูู</button>
      </li>
    </ul>
  </nav>
</div>
